From 1dd1516af479d7097c19c612824881d8b709682e Mon Sep 17 00:00:00 2001
From: Felicitas Pojtinger <felicitas@pojtinger.com>
Date: Fri, 03 Oct 2025 23:34:29 -0700
Subject: [PATCH] GIR: Implement support for generating getters and setters for callbacks based on GIR instead of generating untyped pointers

Signed-off-by: Felicitas Pojtinger <felicitas@pojtinger.com>
---
diff --git a/gen.go b/gen.go
index 921109acc601f9c8c4b9db7e0ca12e5021e2c31d..97557c051e7e8f2bd3d227416ff42b04345333d7 100644
--- a/gen.go
+++ b/gen.go
@@ -31,7 +31,14 @@ 	// collect basic type info
 	p.First()
 
 	// Create the template
-	gotemp, err := template.New("go").Funcs(template.FuncMap{"conv": util.ConvertArgs, "convc": util.ConvertArgsComma}).ParseFiles("templates/go")
+	gotemp, err := template.New("go").Funcs(template.FuncMap{
+		"conv":     util.ConvertArgs,
+		"convc":    util.ConvertArgsComma,
+		"convcb":   util.ConvertCallbackArgs,
+		"convcd":   util.ConvertArgsCommaDeref,
+		"convd":    util.ConvertArgsDeref,
+		"convcbne": util.ConvertCallbackArgsNoErr,
+	}).ParseFiles("templates/go")
 	if err != nil {
 		panic(err)
 	}
diff --git a/internal/gir/pass/pass.go b/internal/gir/pass/pass.go
index bdbedb2a28c22b09be5e906042da308e2d796029..75feadb1be93a6b1b89c19c2c4326e15d85792ab 100644
--- a/internal/gir/pass/pass.go
+++ b/internal/gir/pass/pass.go
@@ -99,6 +99,11 @@ 		files = append(files, fn)
 		constants[fn] = append(constants[fn], con.Template(ns.Name, p.Types))
 	}
 
+	callbackDocs := make(map[string]string)
+	for _, cb := range ns.Callbacks {
+		callbackDocs[cb.Name] = cb.Doc.StringSafe()
+	}
+
 	records := make(map[string][]types.RecordTemplate)
 	recordLookup := make(map[string]bool)
 	for _, rec := range ns.Records {
@@ -106,6 +111,7 @@ 		name := util.SnakeToCamel(rec.Name)
 		constructors := make([]types.FuncTemplate, len(rec.Constructors))
 		receivers := make([]types.FuncTemplate, 0, len(rec.Methods))
 		fields := make([]types.RecordField, 0, len(rec.Fields))
+		callbackAccessors := make([]types.CallbackAccessor, 0)
 		fn := rec.FilenameSafe()
 		files = append(files, fn)
 		for i, c := range rec.Constructors {
@@ -119,11 +125,40 @@ 			}
 		}
 		for _, f := range rec.Fields {
 			var _type string
-			
+			var fieldName string
+
 			// Check if this field is a callback
 			if f.Callback != nil {
-				// Callbacks in structs are function pointers, represented as uintptr
 				_type = "uintptr"
+				fieldName = "x" + util.SnakeToCamel(f.Name) // Prefix callback pointer fields with `x` to make them private
+
+				callbackName := util.SnakeToCamel(f.Name)
+				args := f.Callback.Parameters.Template(ns.Name, "", p.Types, f.Callback.Throws)
+				ret := f.Callback.ReturnValue.Template(ns.Name, "", p.Types, f.Callback.Throws)
+
+				apiTypes := args.API.Types
+
+				var doc string
+				if f.Callback.Doc != nil && f.Callback.Doc.String != "" {
+					doc = f.Callback.Doc.StringSafe()
+				} else {
+					baseClassName := strings.TrimSuffix(rec.Name, "Class")
+					callbackName := baseClassName + util.SnakeToCamel(f.Name) + "Func"
+
+					if callbackDoc, exists := callbackDocs[callbackName]; exists && callbackDoc != "" {
+						doc = callbackDoc
+					} else {
+						doc = f.Doc.StringSafe()
+					}
+				}
+
+				callbackAccessors = append(callbackAccessors, types.CallbackAccessor{
+					Name:         callbackName,
+					Doc:          doc,
+					CallbackType: "func(" + strings.Join(apiTypes, ", ") + ") " + ret.Value,
+					Args:         args,
+					Ret:          ret,
+				})
 			} else {
 				_type = f.Translate(ns.Name, p.Types)
 				if _type == "" {
@@ -140,10 +175,11 @@ 				// HACK: in structs the strings should be uintptr as we convert it ourselves
 				if _type == "string" {
 					_type = "uintptr"
 				}
+				fieldName = util.SnakeToCamel(f.Name)
 			}
-			
+
 			fields = append(fields, types.RecordField{
-				Name: util.SnakeToCamel(f.Name),
+				Name: fieldName,
 				Type: _type,
 			})
 		}
@@ -167,12 +203,13 @@ 				Ret:   f.ReturnValue.Template(ns.Name, "", p.Types, f.Throws),
 			})
 		}
 		records[fn] = append(records[fn], types.RecordTemplate{
-			Name:         name,
-			Doc:          rec.Doc.StringSafe(),
-			Constructors: constructors,
-			Receivers:    receivers,
-			Fields:       fields,
-			TypeGetter:   rec.GLibGetType,
+			Name:              name,
+			Doc:               rec.Doc.StringSafe(),
+			Constructors:      constructors,
+			Receivers:         receivers,
+			Fields:            fields,
+			CallbackAccessors: callbackAccessors,
+			TypeGetter:        rec.GLibGetType,
 		})
 		recordLookup[name] = true
 	}
diff --git a/internal/gir/types/template.go b/internal/gir/types/template.go
index 77914bb8f0d8fcc3a453c45f9d1067861fff801d..7bb793d0464b6b60707dc981ec6721619c5fe3ca 100644
--- a/internal/gir/types/template.go
+++ b/internal/gir/types/template.go
@@ -85,14 +85,22 @@ 		if stars == 0 {
 			t = "uintptr"
 		}
 	case CallbackType:
+		c = fmt.Sprintf("(*%s)(unsafe.Pointer(%s))", strings.TrimPrefix(t, "*"), n)
 		t = "uintptr"
 	case ClassesType:
 		if stars == 0 {
 			c = n
 			t = "uintptr"
 		} else {
-			c = fmt.Sprintf("%sNewFromInternalPtr(%s)", strings.TrimPrefix(t, "*"), n)
-			t = strings.Repeat("*", stars-1) + "uintptr"
+			// Remove all dereference operators to get the base class name
+			baseName := strings.TrimPrefix(t, strings.Repeat("*", stars))
+			if stars > 1 {
+				// For double pointers like **ParamSpec, we need to pass the double pointer directly
+				c = fmt.Sprintf("(**%s)(unsafe.Pointer(%s))", baseName, n)
+			} else {
+				c = fmt.Sprintf("%sNewFromInternalPtr(%s)", baseName, n)
+			}
+			t = "uintptr"
 		}
 	case InterfacesType:
 		if stars == 0 {
@@ -175,6 +183,23 @@ 	// Type is the Go type of the field
 	Type string
 }
 
+type CallbackAccessor struct {
+	// Name is the Go name of the callback field (without x prefix)
+	Name string
+
+	// Doc is the documentation for the callback
+	Doc string
+
+	// CallbackType is the name of the callback function type
+	CallbackType string
+
+	// Args are the callback function arguments template
+	Args funcArgsTemplate
+
+	// Ret is the callback function return template
+	Ret funcRetTemplate
+}
+
 type RecordTemplate struct {
 	// Name is the name of the record given to the Go type declaration
 	Name string
@@ -190,6 +215,9 @@ 	Receivers []FuncTemplate
 
 	// Fields is the list of record fields
 	Fields []RecordField
+
+	// CallbackAccessors are the setter/getter methods for callback fields
+	CallbackAccessors []CallbackAccessor
 
 	// TypeGetter is the function to get the GLib type
 	TypeGetter string
diff --git a/internal/gir/util/util.go b/internal/gir/util/util.go
index 1fd741a45634383f3e5bef6bd761df5b805fca04..4fa86cb2b68b4ff000427632fd176c081373224e 100644
--- a/internal/gir/util/util.go
+++ b/internal/gir/util/util.go
@@ -9,6 +9,18 @@ 	"path/filepath"
 	"strings"
 )
 
+var (
+	// Variable names that should not be dereferenced when using ConvertPtr() in handlePtr mode
+	// TODO: This was mostly discovered via trial and error, and might point towards issues in
+	// the GIR files
+	specialConvertPtrVars = []string{
+		"ModelVar",
+		"TreeModelVar",
+		"OutChildVar",
+		"ChildVar",
+	}
+)
+
 // delimToCamel to camel converts a string with parts separated by `delim` to CamelCase
 func delimToCamel(s string, delim string) string {
 	var sb strings.Builder
@@ -121,6 +133,70 @@ 	if len(a) == 0 {
 		return ""
 	}
 	return ", " + strings.Join(a, ", ")
+}
+
+func convertCallbackArgs(a []string, prependComma, skipEmpty, skipErr, handlePtr bool) string {
+	var validArgs []string
+	for _, arg := range a {
+		if skipEmpty && arg == "" {
+			continue
+		}
+		if skipErr && arg == "&cerr" {
+			continue
+		}
+
+		if strings.Contains(arg, "{Ptr:") {
+			if !handlePtr {
+				// For ConvertCallbackArgs: remove * prefix and add &
+				arg = strings.TrimPrefix(arg, "*")
+			}
+			validArgs = append(validArgs, "&"+arg)
+		} else if strings.Contains(arg, "ConvertPtr(") && handlePtr {
+			isSpecialVar := false
+			for _, specialVar := range specialConvertPtrVars {
+				if strings.Contains(arg, specialVar) {
+					isSpecialVar = true
+
+					break
+				}
+			}
+
+			if isSpecialVar {
+				validArgs = append(validArgs, arg)
+			} else {
+				validArgs = append(validArgs, "*"+arg)
+			}
+		} else {
+			validArgs = append(validArgs, arg)
+		}
+	}
+
+	if len(validArgs) == 0 {
+		return ""
+	}
+
+	result := strings.Join(validArgs, ", ")
+	if prependComma {
+		return ", " + result
+	}
+
+	return result
+}
+
+func ConvertCallbackArgs(a []string) string {
+	return convertCallbackArgs(a, false, false, false, false)
+}
+
+func ConvertArgsCommaDeref(a []string) string {
+	return convertCallbackArgs(a, true, true, false, true)
+}
+
+func ConvertArgsDeref(a []string) string {
+	return convertCallbackArgs(a, false, true, false, true)
+}
+
+func ConvertCallbackArgsNoErr(a []string) string {
+	return convertCallbackArgs(a, false, true, true, true)
 }
 
 // ConstructorName returns a Go friendly constructor name given the raw constructor name `name` and the class/record name `outer`
diff --git a/pkg/gir/util/util.go b/pkg/gir/util/util.go
new file mode 100644
index 0000000000000000000000000000000000000000..8464d3ddf428488bb342011dcf06b69df5b80f0f
--- /dev/null
+++ b/pkg/gir/util/util.go
@@ -0,0 +1,12 @@
+package util
+
+import "github.com/jwijenbergh/puregotk/internal/gir/util"
+
+var (
+	ConvertArgs            = util.ConvertArgs
+	ConvertArgsComma       = util.ConvertArgsComma
+	ConvertCallbackArgs    = util.ConvertCallbackArgs
+	ConvertArgsCommaDeref  = util.ConvertArgsCommaDeref
+	ConvertArgsDeref       = util.ConvertArgsDeref
+	ConvertCallbackArgsNoErr = util.ConvertCallbackArgsNoErr
+)
\ No newline at end of file
diff --git a/templates/go b/templates/go
index 3bc6fa583d766515fd22da01f41ee4fa46e6228c..c9a207f535f4e35b25e6554ed5461ec273bd81be 100644
--- a/templates/go
+++ b/templates/go
@@ -66,7 +66,7 @@
 {{.Doc}}
 func {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret :={{end}}x{{.Name}}({{conv .Args.API.Call}})
+     {{if .Ret.Value}}cret :={{end}}x{{.Name}}({{convd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
@@ -78,11 +78,48 @@
 {{.Doc}}
 func (x *{{$outer.Name}}) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret :={{end}}x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convc .Args.API.Call}})
+     {{if .Ret.Value}}cret :={{end}}x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convcd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
 
+{{range .CallbackAccessors -}}
+{{if .Doc}}// SetCallback{{.Name}} sets the callback function.
+{{.Doc}}{{else}}// SetCallback{{.Name}} sets the callback function.{{end}}
+func (x *{{$outer.Name}}) SetCallback{{.Name}}(cb {{.CallbackType}}) {
+     if cb == nil {
+          x.x{{.Name}} = 0
+     } else {
+          x.x{{.Name}} = purego.NewCallback(func({{conv .Args.Pure.Full}}) {{.Ret.Raw}} {
+               {{if .Ret.Value}}{{if .Ret.Class}}ret := cb({{convcb .Args.Pure.Call}})
+               if ret == nil {
+                    return 0
+               }
+               return ret.GoPointer(){{else}}return cb({{convcb .Args.Pure.Call}}){{end}}{{else}}cb({{convcb .Args.Pure.Call}}){{end}}
+          })
+     }
+}
+
+{{if .Doc}}// GetCallback{{.Name}} gets the callback function.
+{{.Doc}}{{else}}// GetCallback{{.Name}} gets the callback function.{{end}}
+func (x *{{$outer.Name}}) GetCallback{{.Name}}() {{.CallbackType}} {
+     if x.x{{.Name}} == 0 {
+          return nil
+     }
+     var rawCallback func({{conv .Args.Pure.Full}}) {{.Ret.Raw}}
+     purego.RegisterFunc(&rawCallback, x.x{{.Name}})
+     return func({{conv .Args.API.Full}}) {{.Ret.Value}} {
+          {{if .Ret.Value}}{{if .Ret.Class}}rawRet := rawCallback({{convcbne .Args.API.Call}})
+          if rawRet == 0 {
+               return nil
+          }
+          ret := {{.Ret.Instance}}
+          ret.Ptr = rawRet
+          return ret{{else}}return rawCallback({{convcbne .Args.API.Call}}){{end}}{{else}}rawCallback({{convcbne .Args.API.Call}}){{end}}
+     }
+}
+{{end}}
+
 {{end}}
 
 {{range .Interfaces -}}
@@ -91,7 +128,7 @@ type {{.Name}} interface {
      GoPointer() uintptr
      SetGoPointer(uintptr)
      {{range .Methods -}}
-     {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}}
+     {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}}
      {{end}}
 }
 
@@ -122,7 +159,7 @@ {{range .Methods -}}
 {{.Doc}}
 func (x *{{$outer.Name}}Base) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret := {{end}}{{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
+     {{if .Ret.Value}}cret := {{end}}{{.Namespace}}X{{.FullName}}(x.GoPointer() {{convcd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
@@ -176,7 +213,7 @@
 {{.Doc}}
 func {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret := {{end}}x{{.Name}}({{conv .Args.API.Call}})
+     {{if .Ret.Value}}cret := {{end}}x{{.Name}}({{convd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
@@ -211,7 +248,7 @@
 {{.Doc}}
 func {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret :={{end}}x{{.Name}}({{conv .Args.API.Call}})
+     {{if .Ret.Value}}cret :={{end}}x{{.Name}}({{convd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
@@ -223,7 +260,7 @@
 {{.Doc}}
 func (x *{{$outer.Name}}) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret :={{end}}x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convc .Args.API.Call}})
+     {{if .Ret.Value}}cret :={{end}}x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convcd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
@@ -272,7 +309,7 @@ {{range .Methods -}}
 {{.Doc}}
 func (x *{{$outer.Name}}) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret := {{end}} {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
+     {{if .Ret.Value}}cret := {{end}} {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convcd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}
@@ -284,7 +321,7 @@
 {{.Doc}}
 func {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Return}} {
      {{.Ret.Preamble $NotGLib}}
-     {{if .Ret.Value}}cret := {{end}}x{{.Name}}({{conv .Args.API.Call}})
+     {{if .Ret.Value}}cret := {{end}}x{{.Name}}({{convd .Args.API.Call}})
      {{.Ret.Fmt $NotGObject}}
 }
 {{end}}

