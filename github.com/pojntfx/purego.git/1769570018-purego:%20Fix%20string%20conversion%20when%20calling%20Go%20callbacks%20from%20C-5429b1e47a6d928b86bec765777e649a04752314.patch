From 5429b1e47a6d928b86bec765777e649a04752314 Mon Sep 17 00:00:00 2001
From: Felicitas Pojtinger <felicitas@pojtinger.com>
Date: Tue, 27 Jan 2026 19:13:38 -0800
Subject: [PATCH] purego: Fix string conversion when calling Go callbacks from C

Signed-off-by: Felicitas Pojtinger <felicitas@pojtinger.com>
---
diff --git a/callback_test.go b/callback_test.go
index da632d2778c45c0e7844ab452f548d93b09314cd..b059bcef81a990dd4db740801480365fc916088f 100644
--- a/callback_test.go
+++ b/callback_test.go
@@ -50,6 +50,43 @@ 		}
 	}
 }
 
+// TestCallbackStringConversion tests that C char* arguments are correctly
+// converted to Go strings when the callback signature uses string type.
+func TestCallbackStringConversion(t *testing.T) {
+	libFileName := filepath.Join(t.TempDir(), "libcbtest.so")
+	t.Logf("Build %v", libFileName)
+
+	if err := buildSharedLib("CC", libFileName, filepath.Join("testdata", "libcbtest", "callback_test.c")); err != nil {
+		t.Fatal(err)
+	}
+	defer os.Remove(libFileName)
+
+	lib, err := purego.Dlopen(libFileName, purego.RTLD_NOW|purego.RTLD_GLOBAL)
+	if err != nil {
+		t.Fatalf("Dlopen(%q) failed: %v", libFileName, err)
+	}
+
+	var callCallback func(p uintptr, s string) int
+	purego.RegisterLibFunc(&callCallback, lib, "callCallback")
+
+	const expected = "a test string"
+	var got string
+	goFunc := func(s string, n int) int {
+		got = s
+		if len(s) != n {
+			t.Errorf("string length mismatch: got %d, want %d", len(s), n)
+		}
+		return 1
+	}
+
+	cb := purego.NewCallback(goFunc)
+	callCallback(cb, expected)
+
+	if got != expected {
+		t.Errorf("string callback got %q, want %q", got, expected)
+	}
+}
+
 func TestNewCallbackFloat64(t *testing.T) {
 	// This tests the maximum number of arguments a function to NewCallback can take
 	const (
diff --git a/syscall_sysv.go b/syscall_sysv.go
index 06ab3848e39616816d189449ddd148c6e5c37a9f..42f4bc8528723e8e425b4da73ba6480a2ffaff3d 100644
--- a/syscall_sysv.go
+++ b/syscall_sysv.go
@@ -264,6 +264,7 @@ 			floatsN++
 		case reflect.String:
 			addInt()
 			args[i] = reflect.ValueOf(strings.GoString(frame[pos]))
+			continue
 		case reflect.Struct:
 			// This is the CDecl field
 			args[i] = reflect.Zero(fnType.In(i))

